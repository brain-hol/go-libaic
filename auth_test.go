package libaic

import (
	"os"
	"strings"
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestGenerateJWT(t *testing.T) {
	// Because ecdsa is non-deterministic on its signature, we split the assertions
	tests := []struct {
		keyname   string
		expected  string
		signature string
	}{
		{
			"pem_id_ecdsa",
			"eyJhbGciOiJFUzI1NiIsImtpZCI6IkFBQUFFMlZqWkhOaExYTm9ZVEl0Ym1semRIQXlOVFlBQUFBSWJtbHpkSEF5TlRZQUFBQkJCR3h2cnpFZFQ2a29zYkxtMGFtSnBKS0lGdjhmdFQ0ODNIUE85ZU9VQnpxWWRzNisvbXN2b1BvL3JxdzloemxqVlRkMEpmRnhjd0liN0tmMmJMTEN5OFU9IiwidHlwIjoiSldUIn0.eyJub25jZSI6IjczZjczYzdmLTkwMGYtNDViMi1iZWU0LTNkNTdiY2I2NTM4OCIsInN1YiI6ImFtYWRtaW4ifQ",
			"",
		},
		{
			"pem_id_ed25519",
			"eyJhbGciOiJFZERTQSIsImtpZCI6IkFBQUFDM056YUMxbFpESTFOVEU1QUFBQUlObWlzWHZreWxaNE4vU21JMzczOG5UWis2Sy9KdDEyMnhSOVI2SmhQNUlqIiwidHlwIjoiSldUIn0.eyJub25jZSI6IjczZjczYzdmLTkwMGYtNDViMi1iZWU0LTNkNTdiY2I2NTM4OCIsInN1YiI6ImFtYWRtaW4ifQ",
			"VjU1wdBnbGIYdQu8V4GLvq996WGiw_cumYgS1Ce3gNx6Kbdr_CHISt8YoF49HgG-A5WTY67NQ47oQYdCsTX4Dw",
		},
		{
			"pem_id_rsa",
			"eyJhbGciOiJSUzI1NiIsImtpZCI6IkFBQUFCM056YUMxeWMyRUFBQUFEQVFBQkFBQUNBUURHTHlrNWFBOVdJTzdIQk1ZRFIrOVgxUDA2TDlndEpZN2dzdC9rcE9yUkVTVG1mUjBvWVNDdWNHOUVCc1BvWXZOZ1M4SHNtY1NPUjRrVU9sN2dCY3NJVVFsa1NxWmllYWdMTjFzQmxreHA3Q1lDVXdiK0xiREgycDYrbnV6OXJlb08xemVlMG9uU2xUbldpeDU5MGJac1JIUThOWkl6YnBxNzhzZE9VbVhySDh4M01VTEVyTXdabUhZVk1TQzZsbWRNVjdEVDc1bVBHYUNkaU96aFJMSDRPL2J1b2k2SlZpdXpySEhSRHdad0VOV0F3QUZGNzdkRlNkV3o2ZXowMDFXc21SU1NpNGtBZVJnTzgrblpHaFNkLzdWa0lhMzlJeEdyMVNkWXZYNlhvV3JkdXNtanhYT1BwQlY4RmtkN0wyc2psOTQzVFFrcWVRSVFSOUhic1J5ald1anRxOU5CSDZzcFFyWkZCa1dZZzFGa0FLVy84NVhDVkttL1dkS3JhSjVYdkZ0Q2xYZnlialM0bFg3MUVDL0tuS29JVTIzS1FhRFdTbjFwNDVodThwdGlYTWhsZ0JBVEQ5S0Vmb2pwaEg4SlI1VHYrVzJ2cWI2dVNFdGdtQnIwVFMxR2FNa3pacGhFanBHNnNOSFk5a3RJdE1ya2FKUS9Kc0JFNmZma3o1NGtmUUhsQW5IYzdDcU5IZ2N6aHJ5TUJyR3ROcFZjRUUwb0ZwaGM2SEwyWkNRMy9OUEhtcHB1TUpPeWtoNGVPeTdiSjBhcFlURS9rOUJiWEJCdmc1QmVIS3Jhd2hvdDlqRU5iVXUrZFZyd3RMckcrTEZJZHZFVFhpTzZDUTczSnlVKzZ5bTFuN29qUkN2dTQxZkRrZVMxY1JIbXAxMnYrSXVVaU4rbHZ2RGtWUT09IiwidHlwIjoiSldUIn0.eyJub25jZSI6IjczZjczYzdmLTkwMGYtNDViMi1iZWU0LTNkNTdiY2I2NTM4OCIsInN1YiI6ImFtYWRtaW4ifQ",
			"xFcconFIF4ess0nSQgExh9pvejzRaFU59yaAGpmxZxqR03JKnHqlQqO23gRk7N4KlGHx_uiRycjbE38zXgwc4jLWtIAG9cYuM2kPF4ChqigJ9vR2Gq2oXD0auXxIBCnivX9L0rBfCQq5npWAs6vC_-sxyF1eD3beoTXa00Q6TcQKGyu4zFLhrKgaFA6yoxLW69RbHh4GJRttED3SCrc_GK3sr33yNzuTnIsakM7kDf_hUr8liD9Q1PzgTgSLw_bEvO7a2MYju7chW0T_0m2nlqAlvQX_pgcEGDyibAT-OhftoPyv1MmMIfmzbmitNJM07Rs1whCur45bqEQKnH_-YXC9SCZVxAznD1lZFwLQM9uKTJrw6zLiBtzCZeWo7Yj7NwjYW9rN5FonWOamE3A343OKFARU1t-XfHAue-jzgX_upZo1_tR1IxXr7FIZ_kaMiqtghyn4wfMGfsB8H19dwfWYHvEtCe3UG6kks86qxklV8_PYgo7zFmmw4GMgPwvH4MQ4h_NP3Ql8XOVi2IHAJV-f5ILQuVLlqN7oKD_CKuDlqQC8830fIluuBMfHklHHIakHfEswgwRJGKHIEhMHQ6UbOqFkxG5RzihUjKd85pw1BaMKU-uS-MFFdcF8a_8GGQoNdEWFNiNKlNjxxru7HqSqtgo_yt3ubY715cTbD28",
		},
		{
			"ssh_id_ecdsa",
			"eyJhbGciOiJFUzI1NiIsImtpZCI6IkFBQUFFMlZqWkhOaExYTm9ZVEl0Ym1semRIQXlOVFlBQUFBSWJtbHpkSEF5TlRZQUFBQkJCSzJDR0lJcGdNUy9nZDdQaWpQMDJwVEhiUzc1cStOZXRSaWloUFNEMmpJV2dJTmx1aHFPdjBsN3NzblN1a3BlWnlIV25zUWQrdWRnN3M5OEh3SGFsUUE9IiwidHlwIjoiSldUIn0.eyJub25jZSI6IjczZjczYzdmLTkwMGYtNDViMi1iZWU0LTNkNTdiY2I2NTM4OCIsInN1YiI6ImFtYWRtaW4ifQ",
			"",
		},
		{
			"ssh_id_ed25519",
			"eyJhbGciOiJFZERTQSIsImtpZCI6IkFBQUFDM056YUMxbFpESTFOVEU1QUFBQUlJdjVSajJjWEh1dUVFYWtLUzFSblludytZeERPRnFrZlh1YVIrdDVXVkRxIiwidHlwIjoiSldUIn0.eyJub25jZSI6IjczZjczYzdmLTkwMGYtNDViMi1iZWU0LTNkNTdiY2I2NTM4OCIsInN1YiI6ImFtYWRtaW4ifQ",
			"8IMVnM2Hr5Aj0XBFDHgwuoOu3jdhSa5m5VqA9hTCapKR81aeDBOVMn7sbH0BloeQe5Ml_MIgweCGWsYDdSTDAQ",
		},
		{
			"ssh_id_rsa",
			"eyJhbGciOiJSUzI1NiIsImtpZCI6IkFBQUFCM056YUMxeWMyRUFBQUFEQVFBQkFBQUNBUUN5S3BGbGtKNkNyQ1h6SjIyRG5oTG1oWTFIUGIxdTdKb090aHp5QWw0N3E0dUhDSloyb2JXUWs3dlVCdGFwTWpScm9oTTA2Z2Q0QjdhSjBESFFQclNJR2pKeEE4VUZ3MlFqR3FJUGZybHViSXh4cnZXd0dwMmVHVnFCWitzNkt1WGUzVDVFa3ZGell0bmJGQVAxVXdHUDBRcGo2QVZ5M1RDTEo2Ry9CRzNSSDZEWlFCNHZ2T2lNNG5lcGc5cXpTcEhVVU9Zc0lHcUt3QkxXaEtKRkJZTGdFTnAwcUZnVjJYNStlM2xOZDVBVFNna2tKZEJ6OXpCbUhXczdsaGxTUUZjeE9CbThPbTIyMzFLUUdKa0RuZk9ROUVBd2UvMWV0emZMakpCUnF0R1VXL2ZSNHVUMXpVOElpL2hCdFFCNGVTcEdadXlTTC8xbGhhTWtZM3YydExNRWFiYXFxRjF2R05xRUtzRVRqeEV4SHg1dGdOSVFzYXVnRkp5eDFPcmRxKzdQa0pHdVlEemJ6YjN6TXpGa1drVEhXMHNreHZPQTNMMHBEUzF4V1BCMHpNTDdRMlhCeHc3Y3Fyamt6aVgxRTErdkdRZmQ2bDNEZHZMK0hRelZrQStuVHlBSG14WkJraHNQZnM5azhNdDlJZG1NaU9TMUxRaTk1ZGE5QWhobE9ZSXptSkRkbSs0S294N3RzYXpubU5NYkRnaUo0TjRZb3poemo5WXZCVGhrbnhtbjN0L0hpN2dlMUlvSnFReTVrV0RNbkpmYzNmYTg4SzBCNUhUQmo4MjhmU2F5YUhzalNOUStnVDFnK3BUWVRXOXdWZ3psY1paZjhqLy90ZGs1Z2ZlN2hjY2U0ZjZ3S002d3lKMjJoK2dzc2VyUTREVHVTOSt2Tk5NSVJ3T2FHdz09IiwidHlwIjoiSldUIn0.eyJub25jZSI6IjczZjczYzdmLTkwMGYtNDViMi1iZWU0LTNkNTdiY2I2NTM4OCIsInN1YiI6ImFtYWRtaW4ifQ",
			"V7nVO3epkQuqpn4VInPFhIsEwOTYLjopHfzgjK5U6NYpkuW2ZdzSjHnhOpheQs8jnAEZnSviXficxH_Vd0C41yshJUZFG9haxdyWXZ2M_I-I2dWxbZjwFpWuj127IK8pcFY2fSz1zblJ_U-2GOiAuQUkajeTpd-YjmduDx1bP4QM3Gha9eYBWhlXYatA6G3mJXrIPcce4R9m6T29_Ba2jhn6JGpEkCZ0eharkSnUTl12cnNOMEvOr8B2NjkwQPqdNvqRvlr9p1FS0xv_UB46Ly1J-LN3W9RSZ9WrgOJM89Ed3Uqp-6HBr_Cqp-D7F0yGMrKjf_zvleHOk9Im9FyJROj4FAZ7ZkUm3t2uj_Yom1G9GiyDyhZbFSxLi_UlMZE7FaxaxY5X6xTOfUoWId6Y27gXf9C1QSxFn9p6LW_ZzYxYmoRWad8WgUidNXW4PczceQrwRbM4AkFFhOv796G7cxXIDw6ZzhthJnM_6So3wPfXSGkPIIyJM_NftVjSZAKzqZpyY8-aXVbIdrOU1T2qM_-FDSt2TuTtCnSezJjN5wDDNrYaKm5qD4bIrN4pJ_jRsRpIB3euiV59MiuPZ9qyI1aC5wqQWrBcmVSQeJebV_TdCePHo_604dtiy_aJswcGtJJLLlQu3ftgQVhYBI89wkGAl-Wh8lJNfHrGYB6Q2qs",
		},
	}

	for _, tt := range tests {
		t.Run(tt.keyname, func(t *testing.T) {
			assert := assert.New(t)

			keyBytes, err := os.ReadFile("./testdata/" + tt.keyname)
			assert.Nil(err)

			strat := &AmsterAuth{
				Subject:  "amadmin",
				KeyBytes: keyBytes,
			}

			actual, err := strat.generateJWT("73f73c7f-900f-45b2-bee4-3d57bcb65388")
			assert.Nil(err)

			assert.True(strings.HasPrefix(actual, tt.expected))
			assert.True(strings.HasSuffix(actual, tt.signature))
		})
	}
}
